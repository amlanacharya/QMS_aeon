<!-- templates/bluetooth_print.html -->
{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white text-center">
                <h4>Bluetooth Direct Print</h4>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> This feature requires Chrome or Edge browser and a compatible Bluetooth printer.
                </div>
                
                <div class="print-preview p-3 bg-light mb-4">
                    <h5>Print Preview:</h5>
                    <pre id="printContent" class="mb-0">{{ print_content }}</pre>
                </div>
                
                <!-- Specific printer selector -->
                <div class="mb-4">
                    <div class="card">
                        <div class="card-header bg-light">
                            <strong>Printer Selection</strong>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="printerName" class="form-label">Printer Name:</label>
                                <input type="text" class="form-control" id="printerName" value="TC03-BR" placeholder="Enter your printer's name">
                                <div class="form-text">Enter your printer's exact name for better targeting.</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="printerMac" class="form-label">MAC Address:</label>
                                <input type="text" class="form-control" id="printerMac" value="AA:3D:78:AA:DC:13" placeholder="XX:XX:XX:XX:XX:XX" pattern="([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})">
                                <div class="form-text">For reference only. Web Bluetooth can't directly connect by MAC address.</div>
                            </div>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="useSpecificPrinter" checked>
                                <label class="form-check-label" for="useSpecificPrinter">Use specific printer details</label>
                            </div>
                            
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="useThermalCommands" checked>
                                <label class="form-check-label" for="useThermalCommands">Use thermal printer commands</label>
                                <div class="form-text">Turn off if your printer doesn't use ESC/POS commands.</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mb-4">
                    <button id="connectBtn" class="btn btn-primary">
                        <i class="bi bi-bluetooth"></i> Connect to Printer
                    </button>
                    <button id="printBtn" class="btn btn-success" disabled>
                        <i class="bi bi-printer"></i> Print Token
                    </button>
                </div>
                
                <div id="statusMessages" class="alert alert-secondary">
                    Ready to connect...
                </div>
                
                <div id="advancedInfo" class="mt-4">
                    <div class="accordion" id="bluetoothAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="debugHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#debugInfo" aria-expanded="false" aria-controls="debugInfo">
                                    Debug Information (Advanced)
                                </button>
                            </h2>
                            <div id="debugInfo" class="accordion-collapse collapse" aria-labelledby="debugHeading" data-bs-parent="#bluetoothAccordion">
                                <div class="accordion-body">
                                    <div class="mb-3">
                                        <label for="debugOutput" class="form-label">Debug Log:</label>
                                        <div id="debugOutput" class="border p-2 bg-light" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
                                    </div>
                                    <button id="clearLogBtn" class="btn btn-sm btn-outline-secondary">Clear Log</button>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="rawTextHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#rawTextInfo" aria-expanded="false" aria-controls="rawTextInfo">
                                    Raw Text Mode (Fallback)
                                </button>
                            </h2>
                            <div id="rawTextInfo" class="accordion-collapse collapse" aria-labelledby="rawTextHeading" data-bs-parent="#bluetoothAccordion">
                                <div class="accordion-body">
                                    <p>If standard printing fails, you can try raw text mode:</p>
                                    <div class="mb-3">
                                        <label for="rawText" class="form-label">Edit Print Content:</label>
                                        <textarea id="rawText" class="form-control" rows="6">{{ print_content }}</textarea>
                                    </div>
                                    <button id="sendRawTextBtn" class="btn btn-warning" disabled>Send Raw Text</button>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="troubleshootHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#troubleshootInfo" aria-expanded="false" aria-controls="troubleshootInfo">
                                    Troubleshooting Tips
                                </button>
                            </h2>
                            <div id="troubleshootInfo" class="accordion-collapse collapse" aria-labelledby="troubleshootHeading" data-bs-parent="#bluetoothAccordion">
                                <div class="accordion-body">
                                    <ul>
                                        <li>Make sure your printer is turned on and in pairing mode</li>
                                        <li>Try resetting your printer before connecting</li>
                                        <li>Only Chrome and Edge browsers support Web Bluetooth</li>
                                        <li>This feature does not work on iOS devices</li>
                                        <li>Make sure you're using HTTPS or localhost (if using a local server)</li>
                                        <li>Try unchecking "Use thermal printer commands" if your printer behaves differently</li>
                                        <li>Some printers need to be paired in your operating system's Bluetooth settings first</li>
                                        <li>If you see "empty error" messages, try a different device or browser</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer text-center">
                <a href="{{ url_for('admin') if is_admin else 'index' }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
    .print-preview {
        font-family: monospace;
        white-space: pre-wrap;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    #debugOutput {
        font-size: 11px;
    }
</style>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/bluetooth-print.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const connectBtn = document.getElementById('connectBtn');
        const printBtn = document.getElementById('printBtn');
        const sendRawTextBtn = document.getElementById('sendRawTextBtn');
        const statusMessages = document.getElementById('statusMessages');
        const printContent = document.getElementById('printContent').textContent;
        const rawText = document.getElementById('rawText');
        const debugOutput = document.getElementById('debugOutput');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const printerNameInput = document.getElementById('printerName');
        const printerMacInput = document.getElementById('printerMac');
        const useSpecificPrinterCheckbox = document.getElementById('useSpecificPrinter');
        const useThermalCommandsCheckbox = document.getElementById('useThermalCommands');
        
        // Override console.log to capture debug info
        const originalLog = console.log;
        const originalError = console.error;
        
        console.log = function() {
            // Call the original console.log
            originalLog.apply(console, arguments);
            
            // Add to our debug panel
            const message = Array.from(arguments).map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg) : arg
            ).join(' ');
            
            const logLine = document.createElement('div');
            logLine.textContent = `[INFO] ${message}`;
            debugOutput.appendChild(logLine);
            debugOutput.scrollTop = debugOutput.scrollHeight;
        };
        
        console.error = function() {
            // Call the original console.error
            originalError.apply(console, arguments);
            
            // Add to our debug panel with error styling
            const message = Array.from(arguments).map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg) : arg
            ).join(' ');
            
            const logLine = document.createElement('div');
            logLine.textContent = `[ERROR] ${message}`;
            logLine.style.color = 'red';
            debugOutput.appendChild(logLine);
            debugOutput.scrollTop = debugOutput.scrollHeight;
        };
        
        // Clear debug log
        clearLogBtn.addEventListener('click', function() {
            debugOutput.innerHTML = '';
        });
        
        // Check if Web Bluetooth is supported
        if (!navigator.bluetooth) {
            statusMessages.className = 'alert alert-danger';
            statusMessages.textContent = 'Web Bluetooth is not supported in your browser. Please use Chrome or Edge.';
            connectBtn.disabled = true;
            return;
        }
        
        // Format the MAC address as it's being entered
        printerMacInput.addEventListener('input', function(e) {
            // Remove any characters that aren't hexadecimal or separators
            let value = e.target.value.replace(/[^0-9A-Fa-f:-]/g, '').toUpperCase();
            
            // Auto-format: If we have 2 characters and aren't at a separator position, add one
            let parts = value.split(/[:-]/);
            let formatted = "";
            let position = 0;
            
            for (let i = 0; i < parts.length; i++) {
                if (parts[i].length > 2) {
                    // Split this part into chunks of 2
                    while (parts[i].length > 0) {
                        if (position > 0) formatted += ":";
                        formatted += parts[i].substring(0, 2);
                        parts[i] = parts[i].substring(2);
                        position++;
                    }
                } else if (parts[i].length > 0) {
                    if (position > 0) formatted += ":";
                    formatted += parts[i];
                    position++;
                }
            }
            
            // Update the input value with our formatted version
            e.target.value = formatted;
        });
        
        async function tryConnect() {
            statusMessages.className = 'alert alert-info';
            statusMessages.textContent = 'Connecting to printer...';
            
            try {
                console.log('Attempting to connect to Bluetooth printer...');
                
                let specificDevice = null;
                if (useSpecificPrinterCheckbox.checked && printerNameInput.value.trim()) {
                    specificDevice = printerNameInput.value.trim();
                    console.log(`Using specific printer name: ${specificDevice}`);
                    
                    if (printerMacInput.value) {
                        console.log(`MAC address (for reference only): ${printerMacInput.value}`);
                    }
                }
                
                await window.bluetoothPrinter.connect(specificDevice);
                statusMessages.className = 'alert alert-success';
                statusMessages.textContent = 'Connected to printer successfully! Ready to print.';
                printBtn.disabled = false;
                sendRawTextBtn.disabled = false;
                connectBtn.disabled = true;
            } catch (error) {
                let errorMsg = error.message || 'Unknown error';
                if (errorMsg === '{}' || !errorMsg) {
                    errorMsg = 'Connection failed. Try pairing the printer from your system settings first.';
                }
                
                statusMessages.className = 'alert alert-warning';
                statusMessages.textContent = 'Failed to connect: ' + errorMsg;
                console.error('Connection error:', error);
            }
        }
        
        async function doPrint(text, isRawMode = false) {
            statusMessages.className = 'alert alert-info';
            statusMessages.textContent = 'Printing...';
            printBtn.disabled = true;
            sendRawTextBtn.disabled = true;
            
            try {
                console.log(`Sending print job (${isRawMode ? 'raw mode' : 'normal mode'})...`);
                
                // If using raw mode or thermal commands disabled, use direct send
                const useCommands = useThermalCommandsCheckbox.checked && !isRawMode;
                console.log(`Using thermal commands: ${useCommands}`);
                
                if (!useCommands) {
                    // Simple direct text mode
                    await window.bluetoothPrinter.tryDirectWrite(text);
                } else {
                    // Normal print with thermal commands
                    await window.bluetoothPrinter.print(text);
                }
                
                statusMessages.className = 'alert alert-success';
                statusMessages.textContent = 'Printed successfully!';
                
                // Re-enable the print buttons
                printBtn.disabled = false;
                sendRawTextBtn.disabled = false;
            } catch (error) {
                let errorMsg = error.message || 'Unknown error';
                if (errorMsg === '{}' || !errorMsg) {
                    errorMsg = 'Print failed. Try the raw text mode or disable thermal commands.';
                }
                
                statusMessages.className = 'alert alert-danger';
                statusMessages.textContent = 'Print error: ' + errorMsg;
                console.error('Print error:', error);
                
                // Re-enable buttons for retry
                connectBtn.disabled = false;
                printBtn.disabled = false;
                sendRawTextBtn.disabled = false;
            }
        }
        
        connectBtn.addEventListener('click', function() {
            tryConnect();
        });
        
        printBtn.addEventListener('click', function() {
            doPrint(printContent, false);
        });
        
        sendRawTextBtn.addEventListener('click', function() {
            doPrint(rawText.value, true);
        });
    });
</script>
{% endblock %}