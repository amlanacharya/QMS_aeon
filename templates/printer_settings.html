<!-- templates/printer_settings.html -->
{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Printer Management</h4>
                <a href="{{ url_for('admin') }}" class="btn btn-outline-light btn-sm">Back to Admin</a>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Current Printer</h5>
                            </div>
                            <div class="card-body">
                                <div id="current-printer-info">
                                    <div class="text-center py-3" id="printer-status-loading">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Checking printer status...</p>
                                    </div>
                                    
                                    <div id="printer-status-content" class="d-none">
                                        <h5 id="printer-name">No Printer Connected</h5>
                                        <p id="printer-address" class="text-muted small mb-2"></p>
                                        
                                        <div class="d-flex align-items-center mb-3">
                                            <span class="badge rounded-pill" id="status-badge">Status</span>
                                            <span class="ms-2" id="status-text">Unknown</span>
                                        </div>
                                        
                                        <div id="printer-details" class="small text-muted mb-3">
                                            <div><strong>Paper Width:</strong> <span id="paper-width">58mm</span></div>
                                            <div><strong>Connection:</strong> <span id="connection-type">Bluetooth</span></div>
                                            <div><strong>Last Updated:</strong> <span id="last-updated">Never</span></div>
                                        </div>
                                        
                                        <div class="d-grid gap-2">
                                            <button id="test-print-btn" class="btn btn-outline-primary">
                                                <i class="bi bi-printer"></i> Print Test Page
                                            </button>
                                            <button id="refresh-status-btn" class="btn btn-outline-secondary">
                                                <i class="bi bi-arrow-clockwise"></i> Refresh Status
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div id="printer-status-error" class="d-none">
                                        <div class="alert alert-warning">
                                            <i class="bi bi-exclamation-triangle-fill"></i>
                                            <span id="error-message">Could not retrieve printer status</span>
                                        </div>
                                        
                                        <div class="d-grid gap-2 mt-3">
                                            <button id="refresh-error-btn" class="btn btn-outline-secondary">
                                                <i class="bi bi-arrow-clockwise"></i> Try Again
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">Discover Printers</h5>
                            </div>
                            <div class="card-body">
                                <p>Search for Bluetooth printers in range:</p>
                                
                                <div class="d-grid mb-3">
                                    <button id="discover-btn" class="btn btn-primary">
                                        <i class="bi bi-bluetooth"></i> Scan for Printers
                                    </button>
                                </div>
                                
                                <div id="discovery-status" class="d-none">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                            <span class="visually-hidden">Scanning...</span>
                                        </div>
                                        <span>Scanning for devices... <span id="scan-timer">10</span>s</span>
                                    </div>
                                </div>
                                
                                <div id="discovery-results" class="d-none">
                                    <h6>Discovered Devices</h6>
                                    <div class="list-group mb-3" id="device-list"></div>
                                    
                                    <div class="d-grid gap-2">
                                        <button id="scan-again-btn" class="btn btn-outline-primary">
                                            <i class="bi bi-bluetooth"></i> Scan Again
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="discovery-error" class="d-none">
                                    <div class="alert alert-danger">
                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                        <span id="discovery-error-message">Error scanning for devices</span>
                                    </div>
                                </div>
                                
                                <hr>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="show-all-devices">
                                    <label class="form-check-label" for="show-all-devices">Show all Bluetooth devices</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header bg-secondary text-white">
                                <h5 class="mb-0">Manual Connection</h5>
                            </div>
                            <div class="card-body">
                                <form id="manual-connect-form">
                                    <div class="mb-3">
                                        <label for="bluetooth-address" class="form-label">Bluetooth MAC Address</label>
                                        <input type="text" class="form-control" id="bluetooth-address" 
                                               placeholder="e.g., 00:11:22:33:44:55" required>
                                        <div class="form-text">Enter the MAC address of your Bluetooth printer</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="printer-name-input" class="form-label">Printer Name</label>
                                        <input type="text" class="form-control" id="printer-name-input" 
                                               placeholder="e.g., Receipt Printer">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="paper-width-input" class="form-label">Paper Width (mm)</label>
                                        <select class="form-select" id="paper-width-input">
                                            <option value="58">58mm (standard receipt)</option>
                                            <option value="80">80mm (wide receipt)</option>
                                            <option value="72">72mm</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="bluetooth-port" class="form-label">Bluetooth Port</label>
                                        <input type="number" class="form-control" id="bluetooth-port" 
                                               value="1" min="1" max="30">
                                        <div class="form-text">Usually 1 for most Bluetooth printers</div>
                                    </div>
                                    
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="set-default" checked>
                                        <label class="form-check-label" for="set-default">
                                            Set as default printer
                                        </label>
                                    </div>
                                    
                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-plug"></i> Connect
                                        </button>
                                    </div>
                                </form>
                                
                                <div id="manual-connect-status" class="mt-3 d-none">
                                    <!-- Status will be shown here -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header bg-secondary text-white">
                                <h5 class="mb-0">Previously Connected Printers</h5>
                            </div>
                            <div class="card-body">
                                <div id="printer-history-loading" class="text-center py-2">
                                    <div class="spinner-border spinner-border-sm text-secondary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="ms-2">Loading history...</span>
                                </div>
                                
                                <div id="printer-history-content" class="d-none">
                                    <div class="list-group mb-3" id="printer-history-list">
                                        <!-- History items will be dynamically added here -->
                                    </div>
                                    
                                    <div id="no-history" class="text-center py-3 d-none">
                                        <p class="text-muted">No printer connection history</p>
                                    </div>
                                    
                                    <div class="d-grid">
                                        <button id="clear-history-btn" class="btn btn-outline-danger btn-sm">
                                            <i class="bi bi-trash"></i> Clear History
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Device Connection Modal -->
<div class="modal fade" id="connectModal" tabindex="-1" aria-labelledby="connectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="connectModalLabel">Connect to Printer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="connect-form">
                    <div class="mb-3">
                        <label for="modal-device-name" class="form-label">Device Name</label>
                        <input type="text" class="form-control" id="modal-device-name" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modal-device-address" class="form-label">MAC Address</label>
                        <input type="text" class="form-control" id="modal-device-address" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modal-paper-width" class="form-label">Paper Width</label>
                        <select class="form-select" id="modal-paper-width">
                            <option value="58">58mm (standard receipt)</option>
                            <option value="80">80mm (wide receipt)</option>
                            <option value="72">72mm</option>
                        </select>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="modal-set-default" checked>
                        <label class="form-check-label" for="modal-set-default">
                            Set as default printer
                        </label>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        Make sure your printer is turned on and in pairing mode.
                    </div>
                </div>
                
                <div id="connect-status" class="d-none">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Connecting...</span>
                        </div>
                        <p class="mt-2">Connecting to printer...</p>
                    </div>
                </div>
                
                <div id="connect-result" class="d-none">
                    <!-- Result will be shown here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="modal-connect-btn">Connect</button>
                <button type="button" class="btn btn-success d-none" id="modal-done-btn" data-bs-dismiss="modal">Done</button>
                <button type="button" class="btn btn-primary d-none" id="modal-try-again-btn">Try Again</button>
            </div>
        </div>
    </div>
</div>

<!-- PIN Entry Modal -->
<div class="modal fade" id="pinModal" tabindex="-1" aria-labelledby="pinModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pinModalLabel">Enter PIN Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Enter the PIN code shown on your printer or in its documentation:</p>
                <div class="mb-3">
                    <input type="text" class="form-control" id="pin-code" maxlength="8" inputmode="numeric" pattern="[0-9]*">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="pin-submit-btn">Submit</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
    /* Additional CSS for printer settings page */
    #device-list .list-group-item,
    #printer-history-list .list-group-item {
        cursor: pointer;
    }
    
    #device-list .list-group-item:hover,
    #printer-history-list .list-group-item:hover {
        background-color: #f8f9fa;
    }
    
    .device-name {
        font-weight: 500;
    }
    
    .device-address {
        font-size: 0.8rem;
        color: #666;
    }
    
    .printer-icon {
        color: #0d6efd;
    }
    
    #status-badge.bg-success {
        background-color: #198754 !important;
    }
    
    #status-badge.bg-warning {
        background-color: #ffc107 !important;
    }
    
    #status-badge.bg-danger {
        background-color: #dc3545 !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
// JavaScript for printer management interface
document.addEventListener('DOMContentLoaded', function() {
    // Element references
    const statusLoading = document.getElementById('printer-status-loading');
    const statusContent = document.getElementById('printer-status-content');
    const statusError = document.getElementById('printer-status-error');
    const printerName = document.getElementById('printer-name');
    const printerAddress = document.getElementById('printer-address');
    const statusBadge = document.getElementById('status-badge');
    const statusText = document.getElementById('status-text');
    const paperWidth = document.getElementById('paper-width');
    const connectionType = document.getElementById('connection-type');
    const lastUpdated = document.getElementById('last-updated');
    const testPrintBtn = document.getElementById('test-print-btn');
    const refreshStatusBtn = document.getElementById('refresh-status-btn');
    const refreshErrorBtn = document.getElementById('refresh-error-btn');
    const errorMessage = document.getElementById('error-message');
    
    // Discovery elements
    const discoverBtn = document.getElementById('discover-btn');
    const discoveryStatus = document.getElementById('discovery-status');
    const discoveryResults = document.getElementById('discovery-results');
    const discoveryError = document.getElementById('discovery-error');
    const deviceList = document.getElementById('device-list');
    const scanAgainBtn = document.getElementById('scan-again-btn');
    const scanTimer = document.getElementById('scan-timer');
    const showAllDevices = document.getElementById('show-all-devices');
    const discoveryErrorMessage = document.getElementById('discovery-error-message');
    
    // Manual connection elements
    const manualConnectForm = document.getElementById('manual-connect-form');
    const bluetoothAddress = document.getElementById('bluetooth-address');
    const printerNameInput = document.getElementById('printer-name-input');
    const paperWidthInput = document.getElementById('paper-width-input');
    const bluetoothPort = document.getElementById('bluetooth-port');
    const setDefault = document.getElementById('set-default');
    const manualConnectStatus = document.getElementById('manual-connect-status');
    
    // History elements
    const printerHistoryLoading = document.getElementById('printer-history-loading');
    const printerHistoryContent = document.getElementById('printer-history-content');
    const printerHistoryList = document.getElementById('printer-history-list');
    const noHistory = document.getElementById('no-history');
    const clearHistoryBtn = document.getElementById('clear-history-btn');
    
    // Modal elements
    const connectModal = new bootstrap.Modal(document.getElementById('connectModal'));
    const modalDeviceName = document.getElementById('modal-device-name');
    const modalDeviceAddress = document.getElementById('modal-device-address');
    const modalPaperWidth = document.getElementById('modal-paper-width');
    const modalSetDefault = document.getElementById('modal-set-default');
    const modalConnectBtn = document.getElementById('modal-connect-btn');
    const modalDoneBtn = document.getElementById('modal-done-btn');
    const modalTryAgainBtn = document.getElementById('modal-try-again-btn');
    const connectForm = document.getElementById('connect-form');
    const connectStatus = document.getElementById('connect-status');
    const connectResult = document.getElementById('connect-result');
    
    // PIN modal
    const pinModal = new bootstrap.Modal(document.getElementById('pinModal'));
    const pinCode = document.getElementById('pin-code');
    const pinSubmitBtn = document.getElementById('pin-submit-btn');
    
    let currentDevice = null;
    let scanInterval = null;
    
    // Initialize
    loadPrinterStatus();
    loadPrinterHistory();
    
    // Load printer status
    function loadPrinterStatus() {
        showStatusLoading();
        
        fetch('/api/printer/status')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'connected' || data.status === 'disconnected') {
                    updatePrinterInfo(data);
                    showStatusContent();
                } else if (data.status === 'not_configured') {
                    showNoPrinter();
                } else {
                    throw new Error(data.message || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error fetching printer status:', error);
                errorMessage.textContent = error.message || 'Error checking printer status';
                showStatusError();
            });
    }
    
    // Update printer info display
    function updatePrinterInfo(data) {
        const config = data.config || {};
        const address = config.bluetooth_address || '';
        const width = config.paper_width || 58;
        
        // Check if we have a default printer from settings
        fetch('/api/printer/settings')
            .then(response => response.json())
            .then(settingsData => {
                const defaultPrinter = settingsData.default_printer || {};
                
                if (address) {
                    printerName.textContent = defaultPrinter.name || 'Bluetooth Printer';
                    printerAddress.textContent = address;
                    paperWidth.textContent = `${width}mm`;
                    connectionType.textContent = 'Bluetooth';
                    lastUpdated.textContent = new Date().toLocaleTimeString();
                    
                    if (data.status === 'connected') {
                        statusBadge.className = 'badge rounded-pill bg-success';
                        statusBadge.textContent = 'CONNECTED';
                        statusText.textContent = 'Printer is online and ready';
                        testPrintBtn.disabled = false;
                    } else {
                        statusBadge.className = 'badge rounded-pill bg-warning';
                        statusBadge.textContent = 'OFFLINE';
                        statusText.textContent = 'Printer is configured but not reachable';
                        testPrintBtn.disabled = true;
                    }
                } else {
                    showNoPrinter();
                }
            })
            .catch(error => {
                console.error('Error fetching printer settings:', error);
                showNoPrinter();
            });
    }
    
    // Show no printer connected
    function showNoPrinter() {
        printerName.textContent = 'No Printer Connected';
        printerAddress.textContent = '';
        statusBadge.className = 'badge rounded-pill bg-secondary';
        statusBadge.textContent = 'NOT CONFIGURED';
        statusText.textContent = 'No printer has been configured';
        paperWidth.textContent = '--';
        connectionType.textContent = '--';
        lastUpdated.textContent = 'Never';
        testPrintBtn.disabled = true;
        showStatusContent();
    }
    
    // Status display functions
    function showStatusLoading() {
        statusLoading.classList.remove('d-none');
        statusContent.classList.add('d-none');
        statusError.classList.add('d-none');
    }
    
    function showStatusContent() {
        statusLoading.classList.add('d-none');
        statusContent.classList.remove('d-none');
        statusError.classList.add('d-none');
    }
    
    function showStatusError() {
        statusLoading.classList.add('d-none');
        statusContent.classList.add('d-none');
        statusError.classList.remove('d-none');
    }
    
    // Refresh printer status
    refreshStatusBtn.addEventListener('click', loadPrinterStatus);
    refreshErrorBtn.addEventListener('click', loadPrinterStatus);
    
    // Test print
    testPrintBtn.addEventListener('click', function() {
        testPrintBtn.disabled = true;
        testPrintBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Printing...';
        
        fetch('/api/printer/print-test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Test page printed successfully!');
            } else {
                throw new Error(data.message || 'Failed to print test page');
            }
        })
        .catch(error => {
            console.error('Error printing test page:', error);
            alert('Error: ' + (error.message || 'Failed to print test page'));
        })
        .finally(() => {
            testPrintBtn.disabled = false;
            testPrintBtn.innerHTML = '<i class="bi bi-printer"></i> Print Test Page';
        });
    });
    
    // Discover printers
    discoverBtn.addEventListener('click', startDiscovery);
    scanAgainBtn.addEventListener('click', startDiscovery);
    
    function startDiscovery() {
        showDiscoveryStatus();
        
        // Reset timer
        let timeLeft = 10;
        scanTimer.textContent = timeLeft;
        
        // Start countdown
        if (scanInterval) {
            clearInterval(scanInterval);
        }
        
        scanInterval = setInterval(() => {
            timeLeft--;
            scanTimer.textContent = timeLeft;
            
            if (timeLeft <= 0) {
                clearInterval(scanInterval);
            }
        }, 1000);
        
        // Start discovery
        fetch('/api/printer/discover')
            .then(response => response.json())
            .then(data => {
                clearInterval(scanInterval);
                
                if (data.status === 'success') {
                    // Display results
                    displayDiscoveredDevices(data.devices, data.printer_devices);
                    showDiscoveryResults();
                } else {
                    throw new Error(data.message || 'Discovery failed');
                }
            })
            .catch(error => {
                clearInterval(scanInterval);
                console.error('Error discovering devices:', error);
                discoveryErrorMessage.textContent = error.message || 'Error scanning for devices';
                showDiscoveryError();
            });
    }
    
    // Display discovered devices
    function displayDiscoveredDevices(devices, printerDevices) {
        deviceList.innerHTML = '';
        
        if (!devices || devices.length === 0) {
            deviceList.innerHTML = '<p class="text-center py-3 text-muted">No devices found</p>';
            return;
        }
        
        // Create a map of printer devices for quick lookup
        const printerMap = {};
        if (printerDevices && printerDevices.length > 0) {
            printerDevices.forEach(printer => {
                printerMap[printer.address] = true;
            });
        }
        
        // Filter devices if show all is not checked
        let displayDevices = devices;
        if (!showAllDevices.checked) {
            displayDevices = devices.filter(device => {
                return printerMap[device.address] || device.is_printer;
            });
        }
        
        if (displayDevices.length === 0) {
            deviceList.innerHTML = '<p class="text-center py-3 text-muted">No printer devices found</p>';
            if (!showAllDevices.checked) {
                deviceList.innerHTML += '<p class="text-center small">Try enabling "Show all Bluetooth devices"</p>';
            }
            return;
        }
        
        // Create device list
        displayDevices.forEach(device => {
            const isPrinter = printerMap[device.address] || device.is_printer;
            
            const item = document.createElement('a');
            item.href = '#';
            item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
            item.dataset.address = device.address;
            item.dataset.name = device.name;
            
            const nameDiv = document.createElement('div');
            nameDiv.innerHTML = `
                <div class="device-name">${device.name || 'Unknown Device'}</div>
                <div class="device-address">${device.address}</div>
            `;
            
            const iconSpan = document.createElement('span');
            if (isPrinter) {
                iconSpan.innerHTML = '<i class="bi bi-printer printer-icon"></i>';
            } else {
                iconSpan.innerHTML = '<i class="bi bi-bluetooth"></i>';
            }
            
            item.appendChild(nameDiv);
            item.appendChild(iconSpan);
            
            item.addEventListener('click', function(e) {
                e.preventDefault();
                openConnectModal(device);
            });
            
            deviceList.appendChild(item);
        });
    }
    
    // Discovery display functions
    function showDiscoveryStatus() {
        discoveryStatus.classList.remove('d-none');
        discoveryResults.classList.add('d-none');
        discoveryError.classList.add('d-none');
        discoverBtn.disabled = true;
    }
    
    function showDiscoveryResults() {
        discoveryStatus.classList.add('d-none');
        discoveryResults.classList.remove('d-none');
        discoveryError.classList.add('d-none');
        discoverBtn.disabled = false;
    }
    
    function showDiscoveryError() {
        discoveryStatus.classList.add('d-none');
        discoveryResults.classList.add('d-none');
        discoveryError.classList.remove('d-none');
        discoverBtn.disabled = false;
    }
    
    // Toggle show all devices
    showAllDevices.addEventListener('change', function() {
        if (discoveryResults.classList.contains('d-none')) {
            return;
        }
        
        startDiscovery();
    });
    
    // Manual connection form
            manualConnectForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const address = bluetoothAddress.value.trim();
        const name = printerNameInput.value.trim() || 'Manual Printer';
        const port = parseInt(bluetoothPort.value, 10) || 1;
        const width = parseInt(paperWidthInput.value, 10) || 58;
        const isDefault = setDefault.checked;
        
        // Simple MAC address validation
        const macRegex = /^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/;
        if (!macRegex.test(address)) {
            showManualConnectError('Invalid MAC address format. Use format like 00:11:22:33:44:55');
            return;
        }
        
        // Show loading state
        const submitBtn = manualConnectForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Connecting...';
        
        // Clear previous status
        manualConnectStatus.innerHTML = '';
        manualConnectStatus.className = 'mt-3 d-none';
        
        // Connect to printer
        connectToPrinter({
            address: address,
            name: name,
            port: port,
            paper_width: width,
            set_default: isDefault
        })
        .then(result => {
            if (result.success) {
                showManualConnectSuccess('Connected successfully! Printer is ready to use.');
                loadPrinterStatus();
                loadPrinterHistory();
            } else {
                showManualConnectError(result.message || 'Failed to connect to printer');
            }
        })
        .catch(error => {
            showManualConnectError(error.message || 'Connection error');
        })
        .finally(() => {
            // Reset button state
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-plug"></i> Connect';
        });
    });
    
    // Show manual connect status
    function showManualConnectSuccess(message) {
        manualConnectStatus.innerHTML = `
            <div class="alert alert-success">
                <i class="bi bi-check-circle-fill"></i> ${message}
            </div>
        `;
        manualConnectStatus.className = 'mt-3';
    }
    
    function showManualConnectError(message) {
        manualConnectStatus.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle-fill"></i> ${message}
            </div>
        `;
        manualConnectStatus.className = 'mt-3';
    }
    
    // Load printer history
    function loadPrinterHistory() {
        printerHistoryLoading.classList.remove('d-none');
        printerHistoryContent.classList.add('d-none');
        
        fetch('/api/printer/settings')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayPrinterHistory(data.history || []);
                } else {
                    throw new Error(data.message || 'Failed to load printer history');
                }
            })
            .catch(error => {
                console.error('Error loading printer history:', error);
                printerHistoryList.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill"></i> Error loading history
                    </div>
                `;
                printerHistoryLoading.classList.add('d-none');
                printerHistoryContent.classList.remove('d-none');
                noHistory.classList.add('d-none');
            });
    }
    
    // Display printer history
    function displayPrinterHistory(history) {
        printerHistoryList.innerHTML = '';
        
        if (!history || history.length === 0) {
            printerHistoryLoading.classList.add('d-none');
            printerHistoryContent.classList.remove('d-none');
            noHistory.classList.remove('d-none');
            return;
        }
        
        history.forEach(printer => {
            const item = document.createElement('a');
            item.href = '#';
            item.className = 'list-group-item list-group-item-action';
            
            let lastConnected = 'Unknown';
            if (printer.last_connected) {
                try {
                    const date = new Date(printer.last_connected);
                    lastConnected = date.toLocaleString();
                } catch (e) {
                    lastConnected = printer.last_connected;
                }
            }
            
            item.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="device-name">${printer.name || 'Unknown Printer'}</div>
                        <div class="device-address">${printer.address}</div>
                        <div class="small text-muted">Last connected: ${lastConnected}</div>
                    </div>
                    <i class="bi bi-printer printer-icon"></i>
                </div>
            `;
            
            item.addEventListener('click', function(e) {
                e.preventDefault();
                connectToPreviousPrinter(printer);
            });
            
            printerHistoryList.appendChild(item);
        });
        
        printerHistoryLoading.classList.add('d-none');
        printerHistoryContent.classList.remove('d-none');
        noHistory.classList.add('d-none');
    }
    
    // Connect to a printer from history
    function connectToPreviousPrinter(printer) {
        openConnectModal({
            name: printer.name,
            address: printer.address,
            paper_width: printer.paper_width,
            port: printer.port
        });
    }
    
    // Clear printer history
    clearHistoryBtn.addEventListener('click', function() {
        if (!confirm('Are you sure you want to clear your printer connection history?')) {
            return;
        }
        
        fetch('/api/printer/history/clear', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                loadPrinterHistory();
            } else {
                throw new Error(data.message || 'Failed to clear history');
            }
        })
        .catch(error => {
            console.error('Error clearing history:', error);
            alert('Error: ' + (error.message || 'Failed to clear history'));
        });
    });
    
    // Open connect modal
    function openConnectModal(device) {
        currentDevice = device;
        
        // Populate modal fields
        modalDeviceName.value = device.name || 'Unknown Device';
        modalDeviceAddress.value = device.address;
        
        // Set paper width if available
        if (device.paper_width) {
            modalPaperWidth.value = device.paper_width;
        } else {
            // Default to 58mm
            modalPaperWidth.value = '58';
        }
        
        // Reset modal state
        connectForm.classList.remove('d-none');
        connectStatus.classList.add('d-none');
        connectResult.classList.add('d-none');
        modalConnectBtn.classList.remove('d-none');
        modalDoneBtn.classList.add('d-none');
        modalTryAgainBtn.classList.add('d-none');
        
        // Show modal
        connectModal.show();
    }
    
    // Modal connect button
    modalConnectBtn.addEventListener('click', function() {
        if (!currentDevice) {
            return;
        }
        
        // Hide form, show status
        connectForm.classList.add('d-none');
        connectStatus.classList.remove('d-none');
        connectResult.classList.add('d-none');
        modalConnectBtn.classList.add('d-none');
        
        // Connect to printer
        connectToPrinter({
            address: currentDevice.address,
            name: modalDeviceName.value.trim() || currentDevice.name || 'Bluetooth Printer',
            port: currentDevice.port || 1,
            paper_width: parseInt(modalPaperWidth.value, 10),
            set_default: modalSetDefault.checked
        })
        .then(result => {
            if (result.success) {
                showConnectSuccess('Connected successfully! Printer is ready to use.');
                loadPrinterStatus();
                loadPrinterHistory();
            } else {
                showConnectError(result.message || 'Failed to connect to printer');
            }
        })
        .catch(error => {
            showConnectError(error.message || 'Connection error');
        });
    });
    
    // Show connect result
    function showConnectSuccess(message) {
        connectStatus.classList.add('d-none');
        connectResult.classList.remove('d-none');
        connectResult.innerHTML = `
            <div class="alert alert-success">
                <i class="bi bi-check-circle-fill"></i> ${message}
            </div>
        `;
        modalDoneBtn.classList.remove('d-none');
    }
    
    function showConnectError(message) {
        connectStatus.classList.add('d-none');
        connectResult.classList.remove('d-none');
        connectResult.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle-fill"></i> ${message}
            </div>
            <p>Make sure your printer is turned on and in pairing mode.</p>
        `;
        modalTryAgainBtn.classList.remove('d-none');
    }
    
    // Try again button
    modalTryAgainBtn.addEventListener('click', function() {
        // Reset form
        connectForm.classList.remove('d-none');
        connectStatus.classList.add('d-none');
        connectResult.classList.add('d-none');
        modalConnectBtn.classList.remove('d-none');
        modalTryAgainBtn.classList.add('d-none');
    });
    
    // Connect to printer function
    function connectToPrinter(printerConfig) {
        return fetch('/api/printer/connect', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(printerConfig)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                return { success: true, data: data };
            } else {
                return { success: false, message: data.message || 'Connection failed' };
            }
        })
        .catch(error => {
            console.error('Error connecting to printer:', error);
            return { success: false, message: error.message || 'Connection error' };
        });
    }
    
    // PIN submission
    pinSubmitBtn.addEventListener('click', function() {
        const pin = pinCode.value.trim();
        if (!pin || !currentDevice) {
            return;
        }
        
        pinModal.hide();
        
        // Send pairing request with PIN
        fetch('/api/printer/pair', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                address: currentDevice.address,
                pin: pin
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Now try to connect
                openConnectModal(currentDevice);
            } else {
                alert('Pairing failed: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error pairing device:', error);
            alert('Pairing error: ' + (error.message || 'Unknown error'));
        });
    });
});