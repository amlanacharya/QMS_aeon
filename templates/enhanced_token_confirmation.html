<!-- templates/enhanced_token_confirmation.html -->
{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white text-center">
                <h4>Token Generated Successfully!</h4>
            </div>
            <div class="card-body text-center">
                <h2>Your Token Number</h2>
                <div class="display-1 fw-bold text-primary my-3">{{ token.token_number }}</div>
                
                <p class="mb-4">Please keep this token number with you. Your token will be called when it's your turn.</p>
                
                <div id="print-options">
                    <div class="d-grid gap-2 mb-3">
                        <button id="bluetooth-print-btn" class="btn btn-primary btn-lg">
                            <i class="bi bi-bluetooth"></i> Print via Bluetooth
                        </button>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('print_token', token_id=token.id) }}" class="btn btn-outline-primary btn-lg" target="_blank">
                            <i class="bi bi-printer"></i> Print Server Receipt
                        </a>
                        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">Back to Home</a>
                    </div>
                </div>
                
                <div id="print-status" class="d-none">
                    <!-- Status will be shown here -->
                </div>
                
                <!-- Hidden option for standard print if needed -->
                <div class="mt-3">
                    <a href="{{ url_for('standard_print_token', token_id=token.id) }}" class="text-muted small" target="_blank">
                        Use standard printing format
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bluetooth Printer Selection Modal -->
<div class="modal fade" id="btPrinterModal" tabindex="-1" aria-labelledby="btPrinterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="btPrinterModalLabel">Connect to Bluetooth Printer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="bt-scan-status" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Scanning...</span>
                    </div>
                    <p class="mt-2">Scanning for Bluetooth printers...</p>
                </div>
                
                <div id="bt-scan-results" class="d-none">
                    <div class="list-group mb-3" id="bt-device-list">
                        <!-- Devices will be added here -->
                    </div>
                    
                    <div id="bt-no-devices" class="alert alert-warning d-none">
                        <i class="bi bi-exclamation-triangle-fill"></i> No printers found
                    </div>
                </div>
                
                <div id="bt-connect-status" class="d-none">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Connecting...</span>
                        </div>
                        <p class="mt-2">Connecting to printer...</p>
                    </div>
                </div>
                
                <div id="bt-connect-result" class="d-none">
                    <!-- Result will be shown here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="rescan-btn">Rescan</button>
                <button type="button" class="btn btn-success d-none" id="print-now-btn">Print Now</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
    /* Android-specific styles */
    body.android-bt-printing #print-options .btn-outline-primary {
        display: none;
    }
    
    #bt-device-list .list-group-item {
        cursor: pointer;
    }
    
    #bt-device-list .list-group-item:hover {
        background-color: #f8f9fa;
    }
    
    .device-name {
        font-weight: 500;
    }
    
    .device-address {
        font-size: 0.8rem;
        color: #666;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/android_bluetooth.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tokenId = {{ token.id }};
    const bluetoothPrintBtn = document.getElementById('bluetooth-print-btn');
    const printStatus = document.getElementById('print-status');
    const printOptions = document.getElementById('print-options');
    
    // Bluetooth Printer Modal elements
    const btPrinterModal = new bootstrap.Modal(document.getElementById('btPrinterModal'));
    const btScanStatus = document.getElementById('bt-scan-status');
    const btScanResults = document.getElementById('bt-scan-results');
    const btDeviceList = document.getElementById('bt-device-list');
    const btNoDevices = document.getElementById('bt-no-devices');
    const btConnectStatus = document.getElementById('bt-connect-status');
    const btConnectResult = document.getElementById('bt-connect-result');
    const rescanBtn = document.getElementById('rescan-btn');
    const printNowBtn = document.getElementById('print-now-btn');
    
    let selectedDevice = null;
    
    // Print via Bluetooth button click
    bluetoothPrintBtn.addEventListener('click', function() {
        // First check if we have the native Android bridge
        if (window.bluetoothPrinter && window.bluetoothPrinter.isSupported) {
            // Try to print using Android bridge
            printTokenNative();
        } else {
            // Fall back to server-side Bluetooth printing
            startServerPrinting();
        }
    });
    
    // Print token using native Android
    function printTokenNative() {
        // Show status
        showPrintStatus('info', 'Checking Bluetooth printer connection...');
        
        // Try to print
        window.bluetoothPrinter.printToken(tokenId)
            .then(result => {
                showPrintStatus('success', 'Token printed successfully!');
                setTimeout(() => {
                    window.location.href = "{{ url_for('index') }}";
                }, 2000);
            })
            .catch(error => {
                console.error('Error printing:', error);
                
                // Check if we need to connect to a printer
                if (error.message && (
                    error.message.includes('No printer connected') || 
                    error.message.includes('not connected')
                )) {
                    showPrintStatus('warning', 'No printer connected. Please select a printer.');
                    openBluetoothModal();
                } else {
                    showPrintStatus('error', 'Printing failed: ' + error.message);
                    
                    // After a delay, fall back to standard printing
                    setTimeout(() => {
                        resetPrintStatus();
                        showFallbackOption();
                    }, 3000);
                }
            });
    }
    
    // Start server-side Bluetooth printing
    function startServerPrinting() {
        fetch('/api/direct-print/' + tokenId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showPrintStatus('success', 'Token printed successfully!');
                setTimeout(() => {
                    window.location.href = "{{ url_for('index') }}";
                }, 2000);
            } else {
                if (data.needs_setup) {
                    showPrintStatus('warning', 'Printer not configured.');
                    openBluetoothModal();
                } else {
                    showPrintStatus('error', 'Printing failed: ' + data.message);
                    
                    // After a delay, fall back to standard printing
                    setTimeout(() => {
                        resetPrintStatus();
                        showFallbackOption();
                    }, 3000);
                }
            }
        })
        .catch(error => {
            showPrintStatus('error', 'Printing error: ' + error.message);
            
            // After a delay, fall back to standard printing
            setTimeout(() => {
                resetPrintStatus();
                showFallbackOption();
            }, 3000);
        });
    }
    
    // Open Bluetooth printer selection modal
    function openBluetoothModal() {
        resetModalState();
        btPrinterModal.show();
        
        // Start scanning
        if (window.bluetoothPrinter && window.bluetoothPrinter.isSupported) {
            // Native Android scanning
            setupNativeScanning();
        } else {
            // Server-side scanning
            startServerScan();
        }
    }
    
    // Setup native Android scanning
    function setupNativeScanning() {
        // Clear device list
        btDeviceList.innerHTML = '';
        btScanStatus.classList.remove('d-none');
        btScanResults.classList.add('d-none');
        btConnectStatus.classList.add('d-none');
        btConnectResult.classList.add('d-none');
        btNoDevices.classList.add('d-none');
        
        // Add device found listener
        const removeListener = window.bluetoothPrinter.onDeviceFound(device => {
            // Add device to list if it's not already there
            if (!document.querySelector(`[data-address="${device.address}"]`)) {
                addDeviceToList(device);
            }
            
            // Show results
            btScanStatus.classList.add('d-none');
            btScanResults.classList.remove('d-none');
            
            // Check if we have any devices
            if (btDeviceList.children.length === 0) {
                btNoDevices.classList.remove('d-none');
            } else {
                btNoDevices.classList.add('d-none');
            }
        });
        
        // Start scanning
        window.bluetoothPrinter.startScan();
        
        // Stop scanning after 10 seconds
        setTimeout(() => {
            window.bluetoothPrinter.stopScan();
            removeListener();
            
            // If no devices found, show message
            if (btDeviceList.children.length === 0) {
                btScanStatus.classList.add('d-none');
                btScanResults.classList.remove('d-none');
                btNoDevices.classList.remove('d-none');
            } else {
                btScanStatus.classList.add('d-none');
                btScanResults.classList.remove('d-none');
                btNoDevices.classList.add('d-none');
            }
        }, 10000);
    }
    
    // Start server-side Bluetooth scanning
    function startServerScan() {
        // Clear device list
        btDeviceList.innerHTML = '';
        btScanStatus.classList.remove('d-none');
        btScanResults.classList.add('d-none');
        btConnectStatus.classList.add('d-none');
        btConnectResult.classList.add('d-none');
        btNoDevices.classList.add('d-none');
        
        // Fetch devices from server
        fetch('/api/printer/discover')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Add devices to list
                    let printerDevices = data.printer_devices;
                    let devices = data.devices;
                    
                    // Prefer printer devices
                    if (printerDevices && printerDevices.length > 0) {
                        printerDevices.forEach(device => {
                            addDeviceToList(device);
                        });
                    } else if (devices && devices.length > 0) {
                        // Fall back to all devices if no printers found
                        devices.forEach(device => {
                            addDeviceToList(device);
                        });
                    }
                    
                    // Show results
                    btScanStatus.classList.add('d-none');
                    btScanResults.classList.remove('d-none');
                    
                    // Check if we have any devices
                    if (btDeviceList.children.length === 0) {
                        btNoDevices.classList.remove('d-none');
                    } else {
                        btNoDevices.classList.add('d-none');
                    }
                } else {
                    // Show error
                    showScanError(data.message || 'Scanning failed');
                }
            })
            .catch(error => {
                console.error('Error scanning:', error);
                showScanError(error.message || 'Scanning error');
            });
    }
    
    // Add device to list
    function addDeviceToList(device) {
        const item = document.createElement('a');
        item.href = '#';
        item.className = 'list-group-item list-group-item-action';
        item.dataset.address = device.address;
        item.dataset.name = device.name;
        
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="device-name">${device.name || 'Unknown Device'}</div>
                    <div class="device-address">${device.address}</div>
                </div>
                <i class="bi bi-printer"></i>
            </div>
        `;
        
        item.addEventListener('click', function(e) {
            e.preventDefault();
            selectDevice(device);
        });
        
        btDeviceList.appendChild(item);
    }
    
    // Select a device
    function selectDevice(device) {
        selectedDevice = device;
        
        // Highlight selected device
        const items = btDeviceList.querySelectorAll('.list-group-item');
        items.forEach(item => {
            item.classList.remove('active');
        });
        
        const selectedItem = btDeviceList.querySelector(`[data-address="${device.address}"]`);
        if (selectedItem) {
            selectedItem.classList.add('active');
        }
        
        // Show connect button
        printNowBtn.classList.remove('d-none');
    }
    
    // Print now button click
    printNowBtn.addEventListener('click', function() {
        if (!selectedDevice) {
            return;
        }
        
        // Hide results, show connecting status
        btScanResults.classList.add('d-none');
        btConnectStatus.classList.remove('d-none');
        btConnectResult.classList.add('d-none');
        printNowBtn.classList.add('d-none');
        rescanBtn.classList.add('d-none');
        
        // Try to connect and print
        if (window.bluetoothPrinter && window.bluetoothPrinter.isSupported) {
            // Native Android connection
            connectAndPrintNative();
        } else {
            // Server-side connection
            connectAndPrintServer();
        }
    });
    
    // Connect and print using native Android
    function connectAndPrintNative() {
        // First connect to the printer
        window.bluetoothPrinter.connectPrinter(selectedDevice.address)
            .then(result => {
                // Now print
                return window.bluetoothPrinter.printToken(tokenId);
            })
            .then(result => {
                // Show success
                showConnectResult('success', 'Token printed successfully!');
                
                // Close modal and go to home after a delay
                setTimeout(() => {
                    btPrinterModal.hide();
                    window.location.href = "{{ url_for('index') }}";
                }, 2000);
            })
            .catch(error => {
                console.error('Error connecting or printing:', error);
                showConnectResult('error', 'Failed to connect or print: ' + error.message);
            });
    }
    
    // Connect and print using server
    function connectAndPrintServer() {
        // First connect to the printer
        fetch('/api/printer/connect', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                address: selectedDevice.address,
                name: selectedDevice.name || 'Bluetooth Printer',
                set_default: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Now print
                return fetch('/api/direct-print/' + tokenId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
            } else {
                throw new Error(data.message || 'Connection failed');
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success
                showConnectResult('success', 'Token printed successfully!');
                
                // Close modal and go to home after a delay
                setTimeout(() => {
                    btPrinterModal.hide();
                    window.location.href = "{{ url_for('index') }}";
                }, 2000);
            } else {
                throw new Error(data.message || 'Printing failed');
            }
        })
        .catch(error => {
            console.error('Error connecting or printing:', error);
            showConnectResult('error', 'Failed to connect or print: ' + error.message);
        });
    }
    
    // Rescan button click
    rescanBtn.addEventListener('click', function() {
        if (window.bluetoothPrinter && window.bluetoothPrinter.isSupported) {
            setupNativeScanning();
        } else {
            startServerScan();
        }
    });
    
    // Show scan error
    function showScanError(message) {
        btScanStatus.classList.add('d-none');
        btScanResults.classList.remove('d-none');
        btNoDevices.classList.remove('d-none');
        btNoDevices.innerHTML = `
            <i class="bi bi-exclamation-triangle-fill"></i> Error: ${message}
        `;
    }
    
    // Show connect result
    function showConnectResult(type, message) {
        btConnectStatus.classList.add('d-none');
        btConnectResult.classList.remove('d-none');
        
        if (type === 'success') {
            btConnectResult.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill"></i> ${message}
                </div>
            `;
        } else {
            btConnectResult.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill"></i> ${message}
                </div>
            `;
            rescanBtn.classList.remove('d-none');
        }
    }
    
    // Reset modal state
    function resetModalState() {
        selectedDevice = null;
        btScanStatus.classList.remove('d-none');
        btScanResults.classList.add('d-none');
        btConnectStatus.classList.add('d-none');
        btConnectResult.classList.add('d-none');
        btNoDevices.classList.add('d-none');
        printNowBtn.classList.add('d-none');
        rescanBtn.classList.remove('d-none');
        btDeviceList.innerHTML = '';
    }
    
    // Show print status
    function showPrintStatus(type, message) {
        printOptions.classList.add('d-none');
        printStatus.classList.remove('d-none');
        
        if (type === 'success') {
            printStatus.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill"></i> ${message}
                </div>
            `;
        } else if (type === 'error') {
            printStatus.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill"></i> ${message}
                </div>
            `;
        } else if (type === 'warning') {
            printStatus.innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill"></i> ${message}
                </div>
            `;
        } else {
            printStatus.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill"></i> ${message}
                </div>
            `;
        }
    }
    
    // Reset print status
    function resetPrintStatus() {
        printOptions.classList.remove('d-none');
        printStatus.classList.add('d-none');
    }
    
    // Show fallback option
    function showFallbackOption() {
        printOptions.innerHTML = `
            <div class="d-grid gap-2">
                <a href="{{ url_for('print_token', token_id=token.id) }}" class="btn btn-primary btn-lg" target="_blank">
                    <i class="bi bi-printer"></i> Print Receipt
                </a>
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">Back to Home</a>
            </div>
        `;
        printOptions.classList.remove('d-none');
    }
});
</script>
{% endblock %}